(function(a){a.fn.storeLocator=function(c){var b=a.extend({mapDiv:"map",listDiv:"list",formID:"user-location",pinColor:"fe7569",startPinColor:"66bd4a",pinTextColor:"000000",storeLimit:100,distanceAlert:60,xmlLocation:"data/stores.xml",addressErrorMsg:"Please enter valid Indian address address or postcode",googleDistanceMatrixDestinationLimit:25,defaultLat:21.7679,defaultLng:78.8718,defaultLocationName:"New Delhi, India"},c);return this.each(function(){var m=a(this),c=[],h,g={};g.CalcDistanceGoogle=function(i,g){var e=[],f=[];a.each(c,function(b,a){e.push(a.LatLng)});for(var d=0;d<e.length;d=d+b.googleDistanceMatrixDestinationLimit){var h=e.slice(d,Math.min(d+b.googleDistanceMatrixDestinationLimit));f.push(this.CallGoogleDistanceMatrix(d,i,h))}a.when.apply(a,f).then(function(){g(true)})};g.CallGoogleDistanceMatrix=function(e,g,d){var b=a.Deferred(),f=new google.maps.DistanceMatrixService;f.getDistanceMatrix({origins:[g],destinations:d,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL},function(d){if(d&&d.rows.length){var f=d.rows[0].elements;a.each(f,function(a){if(f[a].status!="ZERO_RESULTS")c[e+a].Distance=l(f[a].distance.text)});b.resolve()}});return b.promise()};function l(a){return Number(a.replace(/[^0-9.]/g,""))}function e(a){return a.replace("&","%26").replace(" ","+")}h=new google.maps.Geocoder;function j(){this.geocode=function(b,a){h.geocode({address:b},function(c,e){if(e==google.maps.GeocoderStatus.OK){var b={};b.latitude=c[0].geometry.location.lat();b.longitude=c[0].geometry.location.lng();b.formatted_address=c[0].formatted_address;b.address_components=c[0].address_components;a(b)}else{d("Geocode was not successful for the following reason: "+e);a(null)}})};this.geocodeLatLng=function(b,a){h.geocode({location:b},function(b,c){if(c==google.maps.GeocoderStatus.OK&&b.length)a(b[0]);else{d("Geocode was not successful for the following reason: "+c);a(null)}})}}a(function(){a(document).on("submit","#"+b.formID,function(g){a("#lblError").html("");g.preventDefault();var c=a("form").serialize();c=c.replace("address=","");c==""&&d(b.addressErrorMsg);var h=new j,f=c;h.geocode(f,function(a){if(a!=null){k(a);i(a.latitude,a.longitude)}else d(b.addressErrorMsg)});c=e(c)})});a(document).ready(function(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(function(a){var c=new j,b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);c.geocodeLatLng(b,function(a){if(a)k(a);else f("Error: Unable to geocode address")});i(a.coords.latitude,a.coords.longitude)},function(){f("Tracking of location was not allowed.")});else f(false)});function k(b){a("#lblAddress").html(b.formatted_address);a.each(b.address_components,function(c,b){if(b.types[0]=="postal_code"){a("#address").val(b.short_name);return false}})}function f(c){if(c)var e=c;else var e="Error: Your browser doesn't support geolocation.";d(e+" Using default location.");i(b.defaultLat,b.defaultLng);a("#lblAddress").html(b.defaultLocationName)}function d(b){a("#lblError").html(b)}function i(f,h){a(function(){a.ajax({type:"GET",url:b.xmlLocation,dataType:"xml",success:function(i){c=[];a(i).find("Placemark").each(function(){var b={Name:a(this).find("name").text(),LatLng:new google.maps.LatLng(a(this).find("coordinates").text().split(",")[1],a(this).find("coordinates").text().split(",")[0]),Description:a(this).find("description").text(),Marker:null,Distance:null};c.push(b)});g.CalcDistanceGoogle(new google.maps.LatLng(f,h),function(g){if(!g)d("Unable to calculate distances at this time");else{c.sort(function(a,b){return a.Distance<b.Distance?-1:a.Distance>b.Distance?1:0});c=c.slice(0,b.storeLimit);c[0].Distance>b.distanceAlert&&d("Unfortunately, our closest location is more than "+b.distanceAlert+" miles away.");a(function(){var g=new google.maps.LatLng(f,h),n={center:g,mapTypeId:google.maps.MapTypeId.ROADMAP},l=new google.maps.Map(document.getElementById(b.mapDiv),n),d=new google.maps.InfoWindow,o=k(g,"0",b.startPinColor);o.setAnimation(google.maps.Animation.DROP);var i=new google.maps.LatLngBounds;i.extend(g);a("#"+b.listDiv).empty();a(c).each(function(c,a){i.extend(a.LatLng);letter=String.fromCharCode("A".charCodeAt(0)+c);a.Marker=k(a.LatLng,letter,b.pinColor);j(a);m(letter,a)});l.fitBounds(i);function m(d,c){a("<li />").html('<div class="list-details"><div class="list-content"><div class="list-label">'+d+'</div><div class="loc-name">'+c.Name+'</div> <div class="loc-addr">'+c.Description+"</div>"+(c.Distance?'<div class="loc-addr2"><i>approx. '+c.Distance+" miles</i></div>":"")+'<div class="loc-web"><a href="http://maps.google.co.uk/maps?saddr='+e(a("#address").val())+"+%40"+f+","+h+"&daddr="+e(c.Name)+"+%40"+c.LatLng.lat()+","+c.LatLng.lng()+'&hl=en" target="_blank">&gt;Get directions</a></div></div></div>').click(function(){j(c,"left")}).appendTo("#"+b.listDiv)}function k(f,e,c){var d=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+e+"|"+c+"|"+b.pinTextColor,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34)),a=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",new google.maps.Size(40,37),new google.maps.Point(0,0),new google.maps.Point(12,35));return new google.maps.Marker({position:f,map:l,icon:d,shadow:a,draggable:false})}function j(a,e){var c='<div class="infoWindow"><b>'+a.Name+"</b><div>"+a.Description+"</div>"+(a.Distance?"<div><i>"+a.Distance+" miles</i></div></div>":"</div>");if(e=="left"){d.setContent(c);d.open(a.Marker.get(b.mapDiv),a.Marker)}else google.maps.event.addListener(a.Marker,"click",function(){d.setContent(c);d.open(a.Marker.get(b.mapDiv),a.Marker)})}})}})}})})}})}})(jQuery)